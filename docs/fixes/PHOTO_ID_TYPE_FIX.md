# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ photo_id - –ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ

## –ü—Ä–æ–±–ª–µ–º–∞
–°–∏—Å—Ç–µ–º–∞ –ø–∞–¥–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π `invalid input syntax for type uuid` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å photo_id, —Ç–∞–∫ –∫–∞–∫ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –≤ S3 –∏–º–µ—é—Ç —Ñ–æ—Ä–º–∞—Ç `1771443713337-photo2025...` (timestamp-hash), –∞ –Ω–µ UUID.

## –†–µ—à–µ–Ω–∏–µ

### 1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `FaceEmbedding` (`models/face.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ë—ã–ª–æ:
photo_id = Column(UUID(as_uuid=True), nullable=True, index=True)

# –°—Ç–∞–ª–æ:
photo_id = Column(String(255), nullable=True, index=True)
```

**–û–±–µ –º–æ–¥–µ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:**
- `Face.photo_id` - —Ç–µ–ø–µ—Ä—å `String(255)`
- `FaceEmbedding.photo_id` - —Ç–µ–ø–µ—Ä—å `String(255)`

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω SQL —Å–∫—Ä–∏–ø—Ç (`scripts/init_facepass_tables.sql`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö:**
```sql
-- –ë—ã–ª–æ:
photo_id UUID NULL,

-- –°—Ç–∞–ª–æ:
photo_id VARCHAR(255) NULL,  -- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç UUID –∏ timestamp-hash —Ñ–æ—Ä–º–∞—Ç—ã
```

**–û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public.faces`
- `public.face_embeddings`

### 3. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ–∏—Å–∫–∞ (`app/api/v1/endpoints/faces.py`)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í Pixora –ë–î –ø–æ–ª–µ `id` –∏–º–µ–µ—Ç —Ç–∏–ø UUID, –Ω–æ –º—ã –∏—â–µ–º –ø–æ timestamp-hash –∑–Ω–∞—á–µ–Ω–∏—è–º.

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω –ø–æ–∏—Å–∫ —Å `id` –Ω–∞ `file_name`:

```sql
-- –ë—ã–ª–æ:
WHERE id = ANY(:photo_ids)

-- –°—Ç–∞–ª–æ:
WHERE photo_session_id = :session_id
    AND (file_name = :photo_id_0 
         OR file_name = :photo_id_0 || '.jpg'
         OR file_name = :photo_id_0 || '.jpeg'
         OR file_name = :photo_id_0 || '.png'
         OR file_name = :photo_id_0 || '.webp')
```

**–õ–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:**
- `photo_id` –∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î = –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- –ü–æ–∏—Å–∫ –≤ Pixora –ë–î –ø–æ `file_name` —Å —É—á–µ—Ç–æ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–º—É `photo_id`

### 4. ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (`scripts/migrate_photo_id_to_string.sql`)

**–î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü:**
```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É VARCHAR
ALTER TABLE public.faces ADD COLUMN photo_id_new VARCHAR(255);

-- –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ (UUID ‚Üí —Å—Ç—Ä–æ–∫–∞)
UPDATE public.faces SET photo_id_new = photo_id::text WHERE photo_id IS NOT NULL;

-- –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –∫–æ–ª–æ–Ω–∫—É
ALTER TABLE public.faces DROP COLUMN photo_id;
ALTER TABLE public.faces RENAME COLUMN photo_id_new TO photo_id;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å
CREATE INDEX idx_faces_photo_id ON public.faces(photo_id);
```

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã photo_id

### ‚úÖ UUID —Ñ–æ—Ä–º–∞—Ç:
```
550e8400-e29b-41d4-a716-446655440000
```

### ‚úÖ Timestamp-hash —Ñ–æ—Ä–º–∞—Ç:
```
1771443713337-photo2025-09-13_17-56-48
1769583325329-images
1768828478136-4kccxkc9heq
```

### ‚úÖ –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏:
```
photo_001
image_abc123
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ UUID –∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫–∏
- –ù–æ–≤—ã–µ timestamp-hash –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- VARCHAR(255) –æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤
- –ü–æ–∏—Å–∫ –ø–æ file_name —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü
psql -c "\d public.faces"
psql -c "\d public.face_embeddings"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
psql -c "SELECT photo_id, session_id FROM public.face_embeddings LIMIT 5;"

# –¢–µ—Å—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å –Ω–æ–≤—ã–º–∏ photo_id
python test_real_s3_indexing.py
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ photo_id —Ñ–æ—Ä–º–∞—Ç–∞ `1771443713337-photo2025...`
- ‚úÖ –ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ timestamp-hash
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å Pixora –ë–î

## –§–∞–π–ª—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –ù–æ–≤—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
```bash
psql -f scripts/init_facepass_tables.sql
```

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
```bash
psql -f scripts/migrate_photo_id_to_string.sql
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:**
- UUID photo_id (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- Timestamp-hash photo_id (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑ S3)
- –õ—é–±—ã–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –≤ Pixora –ë–î –ø–æ file_name

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ S3!** üöÄ

**–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∏–ø–æ–º –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞.**