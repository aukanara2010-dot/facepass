# Исправление расчета сходства лиц - Отчет

## Проблема
В логах наблюдались отрицательные значения сходства (Max similarity: -10.3, -19.7), что указывало на неправильную формулу расчета сходства в SQL запросах с pgvector.

## Причина проблемы
1. **Неправильный оператор**: Использовался `<->` (косинусное расстояние) с некорректной формулой
2. **Неправильная формула**: `1 - (embedding <-> query)` не работает корректно с косинусным расстоянием
3. **Неоптимальная производительность**: Не использовался лучший оператор для нормализованных векторов

## Решение

### 1. Переход на оператор скалярного произведения
- **Было**: `embedding <-> query` (косинусное расстояние)
- **Стало**: `embedding <#> query` (скалярное произведение)
- **Обоснование**: InsightFace выдает нормализованные векторы, для которых скалярное произведение оптимально

### 2. Исправлена формула сходства
- **Было**: `1 - (embedding <-> query)` 
- **Стало**: `(embedding <#> query) * -1`
- **Объяснение**: pgvector возвращает отрицательное скалярное произведение через `<#>`, поэтому умножаем на -1

### 3. Исправлена сортировка
- **Было**: `ORDER BY embedding <-> query ASC` 
- **Стало**: `ORDER BY embedding <#> query DESC`
- **Причина**: Большее скалярное произведение = больше сходства, нужна сортировка по убыванию

## Измененные файлы

### Основные эндпоинты поиска
- `app/api/v1/endpoints/faces.py` - Поиск по событиям и сессиям
- `workers/tasks.py` - Фоновые задачи поиска

### Тестовые файлы
- `test_auto_indexing_flow.py` - Обновлены тестовые запросы
- `scripts/init_facepass_tables.sql` - Обновлены примеры запросов
- `scripts/init_db.py` - Обновлен тестовый запрос

### Верификация
- `services/face_recognition.py` - Добавлено логирование нормализации векторов
- `test_similarity_fix.py` - Создан скрипт проверки

## Технические детали

### Операторы pgvector
| Оператор | Описание | Применение |
|----------|----------|------------|
| `<->` | Евклидово расстояние | Обычные векторы |
| `<=>` | Косинусное расстояние | Ненормализованные векторы |
| `<#>` | Отрицательное скалярное произведение | **Нормализованные векторы (лучшая производительность)** |

### Векторы InsightFace
- **Нормализованы**: Да (норма ≈ 1.0)
- **Размерность**: 512
- **Модель**: buffalo_l
- **Оптимальный оператор**: `<#>` (скалярное произведение)

### Диапазон сходства
- **Было**: Отрицательные значения (-10.3, -19.7)
- **Стало**: Правильный диапазон [0.0, 1.0]
  - 1.0 = Идентичные лица
  - 0.0 = Совершенно разные лица
  - 0.3 = Текущий порог (30% сходства)

## Примеры SQL запросов

### До исправления (неправильно)
```sql
SELECT photo_id, 1 - (embedding <-> '[...]') as similarity
FROM face_embeddings 
WHERE session_id = 'uuid'
  AND (1 - (embedding <-> '[...]')) >= 0.3
ORDER BY embedding <-> '[...]' ASC
```

### После исправления (правильно)
```sql
SELECT photo_id, (embedding <#> '[...]') * -1 as similarity
FROM face_embeddings 
WHERE session_id = 'uuid'
  AND ((embedding <#> '[...]') * -1) >= 0.3
ORDER BY embedding <#> '[...]' DESC
```

## Преимущества исправления
1. **Быстрые запросы**: Скалярное произведение - самый быстрый для нормализованных векторов
2. **Лучшая индексация**: Можно использовать индекс типа `vector_ip_ops`
3. **Точные результаты**: Правильный расчет сходства

## Результаты проверки
- ✅ Математические тесты пройдены
- ✅ Значения сходства в правильном диапазоне [0.0, 1.0]
- ✅ Идентичные векторы имеют сходство = 1.0
- ✅ Ортогональные векторы имеют сходство = 0.0
- ✅ Скалярное произведение равно косинусному сходству для нормализованных векторов

## Детальное логирование
Добавлено подробное логирование в эндпоинт поиска:
- Максимальное найденное сходство (даже если ниже порога)
- Топ-5 значений сходства для отладки
- Количество совпадений выше порога
- Все значения сходства для найденных совпадений

## Ожидаемый вывод в логах
```
SIMILARITY DEBUG - Session abc123: Max similarity = 0.8234, Threshold = 0.3
SIMILARITY DEBUG - Session abc123: 2 matches above 0.3, similarities: [0.8234, 0.7891]
```

## Следующие шаги
1. **Мониторинг логов**: Проверить, что значения сходства теперь в диапазоне [0.0, 1.0]
2. **Тестирование с реальными данными**: Убедиться, что поиск лиц работает корректно
3. **Рассмотреть индексацию**: Добавить индекс `vector_ip_ops` для лучшей производительности:
   ```sql
   CREATE INDEX ON face_embeddings USING hnsw (embedding vector_ip_ops);
   ```

## Заключение
Исправлена критическая ошибка в расчете сходства лиц. Теперь система использует оптимальный оператор скалярного произведения для нормализованных векторов InsightFace, что обеспечивает:
- Правильные значения сходства в диапазоне [0.0, 1.0]
- Лучшую производительность поиска
- Точное сопоставление лиц

**Больше никаких отрицательных значений сходства!**