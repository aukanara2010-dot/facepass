<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FacePass - –ù–∞–π–¥–∏ —Å–≤–æ–∏ —Ñ–æ—Ç–æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .event-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .event-details {
            color: #666;
            font-size: 1.1em;
            margin-top: 10px;
        }

        .event-preview {
            margin-top: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .event-preview img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .search-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .camera-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .camera-section.active {
            display: block;
        }

        #video {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        #canvas {
            display: none;
        }

        .capture-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
        }

        .cancel-button {
            background: #f44336;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .results-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .results-stats {
            color: #666;
            font-size: 0.9em;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .photo-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .photo-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .photo-info {
            padding: 15px;
        }

        .similarity-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .download-button {
            display: block;
            width: 100%;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .no-results {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .no-results h3 {
            color: #666;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .event-title {
                font-size: 1.8em;
            }

            .search-button {
                padding: 15px 30px;
                font-size: 1.2em;
            }

            .gallery {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Event Info -->
        <div class="header" id="eventHeader">
            <h1 class="event-title" id="eventTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div class="event-details" id="eventDetails"></div>
            <div class="event-preview" id="eventPreview"></div>
        </div>

        <!-- Error Message -->
        <div class="error" id="errorMessage" style="display: none;"></div>

        <!-- Search Section -->
        <div class="search-section" id="searchSection">
            <h2 style="margin-bottom: 20px; color: #333;">–ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
            <p style="color: #666; margin-bottom: 30px;">
                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏ –∏ –Ω–∞–π—Ç–∏ –≤—Å–µ –≤–∞—à–∏ —Ñ–æ—Ç–æ —Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
            </p>
            <button class="search-button" id="searchButton" onclick="startCamera()">
                üì∏ –ù–∞–π—Ç–∏ –º–æ–∏ —Ñ–æ—Ç–æ
            </button>
        </div>

        <!-- Camera Section -->
        <div class="camera-section" id="cameraSection">
            <h2 style="margin-bottom: 20px; color: #333;">–°–¥–µ–ª–∞–π—Ç–µ —Å–µ–ª—Ñ–∏</h2>
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div>
                <button class="capture-button" onclick="capturePhoto()">üì∑ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
                <button class="cancel-button" onclick="stopCamera()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <h3 style="color: #333;">–ò—â–µ–º –≤–∞—à–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...</h3>
            <p style="color: #666; margin-top: 10px;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
                <div class="results-stats" id="resultsStats"></div>
            </div>
            <div class="gallery" id="gallery"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.origin;
        let eventUUID = null;
        let eventId = null;
        let stream = null;

        // Get event UUID from URL
        function getEventUUID() {
            const params = new URLSearchParams(window.location.search);
            return params.get('e');
        }

        // Load event information
        async function loadEventInfo() {
            eventUUID = getEventUUID();
            
            if (!eventUUID) {
                showError('Event UUID not provided in URL. Please use ?e=your-event-uuid');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/events/public/${eventUUID}`);
                
                if (!response.ok) {
                    throw new Error('Event not found');
                }

                const event = await response.json();
                
                // Store event_uuid for search
                eventId = event.event_uuid;
                
                // Update UI
                document.getElementById('eventTitle').textContent = event.name;
                
                let details = '';
                if (event.location) {
                    details += `üìç ${event.location}`;
                }
                if (event.event_date) {
                    const date = new Date(event.event_date);
                    details += ` ‚Ä¢ üìÖ ${date.toLocaleDateString('ru-RU')}`;
                }
                if (event.description) {
                    details += `<br><br>${event.description}`;
                }
                
                document.getElementById('eventDetails').innerHTML = details;
                
                // Show preview image if available
                if (event.preview_image_url) {
                    document.getElementById('eventPreview').innerHTML = 
                        `<img src="${event.preview_image_url}" alt="Event preview">`;
                }
                
            } catch (error) {
                showError(`Failed to load event: ${error.message}`);
            }
        }

        // Start camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' },
                    audio: false 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                document.getElementById('searchSection').style.display = 'none';
                document.getElementById('cameraSection').classList.add('active');
                
            } catch (error) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.');
                console.error('Camera error:', error);
            }
        }

        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            document.getElementById('cameraSection').classList.remove('active');
            document.getElementById('searchSection').style.display = 'block';
        }

        // Capture photo
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to blob and search
            canvas.toBlob(async (blob) => {
                stopCamera();
                await searchFaces(blob);
            }, 'image/jpeg', 0.95);
        }

        // Search for faces
        async function searchFaces(imageBlob) {
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
            
            try {
                // First, get event by UUID to get event_id
                const eventResponse = await fetch(`${API_BASE_URL}/api/v1/events/uuid/${eventUUID}`);
                if (!eventResponse.ok) {
                    throw new Error('Event not found');
                }
                const eventData = await eventResponse.json();
                const eventIdNumber = eventData.id;
                
                // Prepare form data
                const formData = new FormData();
                formData.append('event_id', eventIdNumber);
                formData.append('file', imageBlob, 'selfie.jpg');
                formData.append('threshold', '0.7');
                formData.append('limit', '50');
                
                // Search faces
                const response = await fetch(`${API_BASE_URL}/api/v1/faces/search`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Search failed');
                }
                
                const data = await response.json();
                
                document.getElementById('loadingSection').classList.remove('active');
                
                displayResults(data);
                
            } catch (error) {
                document.getElementById('loadingSection').classList.remove('active');
                showError(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}`);
                document.getElementById('searchSection').style.display = 'block';
            }
        }

        // Display search results
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const gallery = document.getElementById('gallery');
            const resultsStats = document.getElementById('resultsStats');
            
            resultsSection.classList.add('active');
            gallery.innerHTML = '';
            
            if (data.results.length === 0) {
                gallery.innerHTML = `
                    <div class="no-results" style="grid-column: 1 / -1;">
                        <h3>üòî –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –Ω–∞—à–ª–∏ –≤–∞—à–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ —ç—Ç–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.
                        </p>
                        <button class="search-button" onclick="location.reload()">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
                resultsStats.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å –¥—Ä—É–≥–æ–µ —Å–µ–ª—Ñ–∏ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É';
                return;
            }
            
            // Update stats
            resultsStats.textContent = `–ù–∞–π–¥–µ–Ω–æ ${data.results.length} —Ñ–æ—Ç–æ ‚Ä¢ –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: ${data.query_time_ms.toFixed(0)} –º—Å`;
            
            // Display photos
            data.results.forEach(result => {
                const card = document.createElement('div');
                card.className = 'photo-card';
                
                const similarityPercent = (result.similarity * 100).toFixed(0);
                
                card.innerHTML = `
                    <img src="${result.image_url}" alt="Photo ${result.face_id}" loading="lazy">
                    <div class="photo-info">
                        <span class="similarity-badge">–°—Ö–æ–∂–µ—Å—Ç—å: ${similarityPercent}%</span>
                        <a href="${result.image_url}" target="_blank" class="download-button">
                            üì• –û—Ç–∫—Ä—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
                        </a>
                    </div>
                `;
                
                gallery.appendChild(card);
            });
            
            // Add "Search Again" button at the end
            const searchAgainCard = document.createElement('div');
            searchAgainCard.className = 'photo-card';
            searchAgainCard.style.display = 'flex';
            searchAgainCard.style.alignItems = 'center';
            searchAgainCard.style.justifyContent = 'center';
            searchAgainCard.style.minHeight = '300px';
            searchAgainCard.innerHTML = `
                <button class="search-button" onclick="location.reload()">
                    üîÑ –ò—Å–∫–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            `;
            gallery.appendChild(searchAgainCard);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', loadEventInfo);
    </script>
</body>
</html>
