# üîç Face Search API Documentation

## –û–±–∑–æ—Ä

Endpoint –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ —Å–µ–ª—Ñ–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç InsightFace –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ –∏ pgvector –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.

---

## üìç Endpoint

```
POST /api/v1/faces/search
```

**–¢–∏–ø:** Multipart Form Data

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–ø—É–±–ª–∏—á–Ω—ã–π endpoint)

---

## üì• Request Parameters

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `event_id` | integer | ‚úÖ –î–∞ | ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ |
| `file` | file | ‚úÖ –î–∞ | –°–µ–ª—Ñ–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (JPG, PNG) |
| `threshold` | float | ‚ùå –ù–µ—Ç | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ similarity (0.0-1.0), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.7 |
| `limit` | integer | ‚ùå –ù–µ—Ç | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10 |

---

## üì§ Response

### Success Response (200 OK)

```json
{
  "results": [
    {
      "face_id": 123,
      "event_id": 1,
      "similarity": 0.92,
      "image_url": "https://s3.beget.com/bucket/events/1/photo1.jpg"
    },
    {
      "face_id": 456,
      "event_id": 1,
      "similarity": 0.85,
      "image_url": "https://s3.beget.com/bucket/events/1/photo2.jpg"
    }
  ],
  "query_time_ms": 245.3,
  "task_id": null
}
```

### No Faces Found (200 OK)

```json
{
  "results": [],
  "query_time_ms": 0.0,
  "task_id": null
}
```

### Error Responses

**404 Not Found** - –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
```json
{
  "detail": "Event not found"
}
```

**400 Bad Request** - –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:
```json
{
  "detail": "File must be an image"
}
```

**400 Bad Request** - –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
```json
{
  "detail": "Invalid image: <error details>"
}
```

**500 Internal Server Error** - –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:
```json
{
  "detail": "Face recognition service error: <error details>"
}
```

---

## üîÑ Workflow

### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å image/*)

### 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç InsightFace –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –ª–∏—Ü–∞
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç 512-–º–µ—Ä–Ω—ã–π –≤–µ–∫—Ç–æ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
- –ï—Å–ª–∏ –ª–∏—Ü–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 3. –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ `face_embeddings` —Ç–∞–±–ª–∏—Ü–µ
- **–ö–†–ò–¢–ò–ß–ù–û:** –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `event_id` (–∏–∑–æ–ª—è—Ü–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç pgvector –æ–ø–µ—Ä–∞—Ç–æ—Ä `<->` (cosine distance)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—ã—à–µ `threshold`

### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ face_id –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `faces` —Ç–∞–±–ª–∏—Ü—ã
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –∏–∑ S3

---

## üî¨ SQL Query

```sql
SELECT 
    face_id,
    event_id,
    1 - (embedding <-> '[query_embedding]') as similarity
FROM face_embeddings
WHERE event_id = :event_id
    AND (1 - (embedding <-> '[query_embedding]')) >= :threshold
ORDER BY embedding <-> :query_embedding
LIMIT :limit
```

### –û–ø–µ—Ä–∞—Ç–æ—Ä—ã pgvector:

| –û–ø–µ—Ä–∞—Ç–æ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|----------|----------|---------------|
| `<->` | Cosine distance | –¢–µ–∫—É—â–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ª–∏—Ü) |
| `<#>` | Inner product | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ |
| `<=>` | L2 distance | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ |

**–ü–æ—á–µ–º—É `<->`?**
- Cosine distance –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ª–∏—Ü
- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É [0, 1]
- –£—Å—Ç–æ–π—á–∏–≤ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –≤–µ–∫—Ç–æ—Ä–æ–≤

---

## üìä Response Fields

### FaceSearchResult

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `face_id` | integer | ID —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö |
| `event_id` | integer | ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è |
| `similarity` | float | –°—Ç–µ–ø–µ–Ω—å —Å—Ö–æ–∂–µ—Å—Ç–∏ (0.0-1.0, –≤—ã—à–µ = –±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–µ) |
| `image_url` | string | –ü–æ–ª–Ω—ã–π URL —Ñ–æ—Ç–æ –≤ S3 |

### FaceSearchResponse

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `results` | array | –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π |
| `query_time_ms` | float | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö |
| `task_id` | string\|null | ID Celery –∑–∞–¥–∞—á–∏ (null –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞) |

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### cURL

```bash
curl -X POST "http://localhost:8000/api/v1/faces/search" \
  -F "event_id=1" \
  -F "file=@selfie.jpg" \
  -F "threshold=0.7" \
  -F "limit=10"
```

### Python (requests)

```python
import requests

url = "http://localhost:8000/api/v1/faces/search"

with open("selfie.jpg", "rb") as f:
    files = {"file": f}
    data = {
        "event_id": 1,
        "threshold": 0.7,
        "limit": 10
    }
    response = requests.post(url, files=files, data=data)
    
print(response.json())
```

### JavaScript (fetch)

```javascript
const formData = new FormData();
formData.append('event_id', '1');
formData.append('file', fileInput.files[0]);
formData.append('threshold', '0.7');
formData.append('limit', '10');

const response = await fetch('http://localhost:8000/api/v1/faces/search', {
  method: 'POST',
  body: formData
});

const data = await response.json();
console.log(data);
```

---

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Threshold (–ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏)

| –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|----------|----------|---------------|
| 0.5 | –ù–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ | –ë–æ–ª—å—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è |
| 0.7 | **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π** | –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –ø–æ–ª–Ω–æ—Ç–æ–π |
| 0.8 | –í—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥ | –¢–æ–ª—å–∫–æ –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–µ –ª–∏—Ü–∞ |
| 0.9 | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π | –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –ª–∏—Ü–∞ |

### Limit (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)

- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** 10
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:** 5-50
- **–ú–∞–∫—Å–∏–º—É–º:** –ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

---

## üéØ –ò–∑–æ–ª—è—Ü–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –ü–æ–∏—Å–∫ –≤—Å–µ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ `event_id`

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

1. **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å:** –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ —Å–≤–æ–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ü–æ–∏—Å–∫ –ø–æ –º–µ–Ω—å—à–µ–º—É –Ω–∞–±–æ—Ä—É –¥–∞–Ω–Ω—ã—Ö –±—ã—Å—Ç—Ä–µ–µ
3. **–¢–æ—á–Ω–æ—Å—Ç—å:** –ú–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

### SQL —Ñ–∏–ª—å—Ç—Ä:

```sql
WHERE event_id = :event_id
```

–≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä **–í–°–ï–ì–î–ê** –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢–∏–ø–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ | –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ |
|-------------------------------|--------------|
| 100 —Ñ–æ—Ç–æ | ~50-100 ms |
| 1,000 —Ñ–æ—Ç–æ | ~100-200 ms |
| 10,000 —Ñ–æ—Ç–æ | ~200-500 ms |
| 100,000 —Ñ–æ—Ç–æ | ~500-1000 ms |

### –§–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å:

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞:** ~2-5 —Å–µ–∫—É–Ω–¥ (InsightFace)
2. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫:** ~50-500 ms (pgvector)
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π:** ~10-50 ms (SQL JOIN)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~2-6 —Å–µ–∫—É–Ω–¥

---

## üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 1. –õ–∏—Ü–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–µ–ª—Ñ–∏

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- HTTP 200 OK (–Ω–µ –æ—à–∏–±–∫–∞)
- `query_time_ms = 0.0`

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ
- –õ–∏—Ü–æ –Ω–µ –≤ –∫–∞–¥—Ä–µ
- –°–ª–∏—à–∫–æ–º —Ç—ë–º–Ω–æ–µ/—Å–≤–µ—Ç–ª–æ–µ —Ñ–æ—Ç–æ

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ
- –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å—ä—ë–º–∫–µ —Å–µ–ª—Ñ–∏

---

### 2. –ù–µ—Å–∫–æ–ª—å–∫–æ –ª–∏—Ü –≤ —Å–µ–ª—Ñ–∏

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–≤–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–µ –ª–∏—Ü–æ
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–æ–∏—Å–∫

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ü–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ —Å –æ–¥–Ω–∏–º –ª–∏—Ü–æ–º

---

### 3. InsightFace –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- HTTP 500 Internal Server Error
- –°–æ–æ–±—â–µ–Ω–∏–µ: "Face recognition service error: ..."

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É InsightFace

---

### 4. –û—à–∏–±–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- HTTP 500 Internal Server Error
- –°–æ–æ–±—â–µ–Ω–∏–µ: "Search failed: ..."

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ vector DB
- –¢–∞–±–ª–∏—Ü–∞ `face_embeddings` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –û—à–∏–±–∫–∞ –≤ SQL –∑–∞–ø—Ä–æ—Å–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –ó–∞–ø—É—Å—Ç–∏—Ç—å `scripts/init_db.py`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ PostgreSQL

---

## üé® UI/UX —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:

1. **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å:**
   ```
   "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–µ —Ñ–æ—Ç–æ..." (2-5 —Å–µ–∫)
   "–ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è..." (0.5-1 —Å–µ–∫)
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   ```
   "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –Ω–∞—à–ª–∏ –≤–∞—à–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ —ç—Ç–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.
   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ —Å–µ–ª—Ñ–∏ –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏."
   ```

3. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ similarity (–≤—ã—à–µ = –ª—É—á—à–µ)
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏: `similarity * 100%`
   - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ similarity (–æ—Ç–ª–∏—á–Ω—ã–µ, —Ö–æ—Ä–æ—à–∏–µ, –≤–æ–∑–º–æ–∂–Ω—ã–µ)

4. **–ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `image_url` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª"
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å similarity score

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –ø–æ event_id
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚ùå –ù–µ—Ç rate limiting
- ‚ùå –ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production:

1. **Rate Limiting:**
   ```python
   from slowapi import Limiter
   
   @limiter.limit("10/minute")
   async def search_faces(...):
   ```

2. **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:**
   ```python
   MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB
   
   if len(file_data) > MAX_FILE_SIZE:
       raise HTTPException(400, "File too large")
   ```

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
   ```python
   from PIL import Image
   
   try:
       img = Image.open(io.BytesIO(file_data))
       img.verify()
   except:
       raise HTTPException(400, "Invalid image file")
   ```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
   - `query_time_ms` –≤ –æ—Ç–≤–µ—Ç–µ
   - –°—Ä–µ–¥–Ω–∏–π, –º–µ–¥–∏–∞–Ω–Ω—ã–π, 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å

2. **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å:**
   - –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏
   - –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤ –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ threshold –∑–Ω–∞—á–µ–Ω–∏—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
import logging

logger.info(f"Face search: event_id={event_id}, threshold={threshold}, "
           f"results={len(results)}, time={query_time_ms:.2f}ms")
```

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**Face Search API –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω!**

‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ —Å InsightFace
‚úÖ –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å pgvector (cosine distance)
‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º (event_id —Ñ–∏–ª—å—Ç—Ä)
‚úÖ –í–æ–∑–≤—Ä–∞—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –∏–∑ S3
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞:** ~2-6 —Å–µ–∫—É–Ω–¥
**–¢–æ—á–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è (buffalo_l –º–æ–¥–µ–ª—å)
**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –î–æ 100,000+ —Ñ–æ—Ç–æ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- [INSIGHTFACE_INTEGRATION.md](./INSIGHTFACE_INTEGRATION.md) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è InsightFace
- [EVENT_ARCHITECTURE.md](./EVENT_ARCHITECTURE.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
- [API_ENDPOINTS.md](./API_ENDPOINTS.md) - –í—Å–µ API endpoints

**FacePass –≥–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É –ª–∏—Ü!** üîçüé≠
