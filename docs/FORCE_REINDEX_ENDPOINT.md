# Эндпоинт принудительной переиндексации

## Описание проблемы

В локальной векторной базе `facepass_vector` было только 3 записи, хотя в облачной базе данных (155.212.216.176) в таблице `photos` уже 13 записей. Поиск работал только по этим трем записям.

## Решение

Создан новый эндпоинт `POST /api/v1/faces/force-reindex-session/{session_id}` для принудительной переиндексации сессии из облачной базы данных.

## Функциональность

Эндпоинт выполняет следующие действия:

1. **Получает все photo_id из облачной базы данных** для указанной сессии
2. **Проверяет их наличие в локальной face_embeddings** таблице
3. **Для отсутствующих фото:**
   - Скачивает изображения по preview_path из облака
   - Извлекает эмбеддинги лиц с помощью InsightFace
   - Сохраняет эмбеддинги в локальную векторную базу
4. **Выводит подробные логи** процесса обработки

## Использование

### Через API

```bash
curl -X POST "http://localhost:8000/api/v1/faces/force-reindex-session/f1896ee0-d548-4676-a0a5-02ac09e6aad9"
```

### Через тестовый скрипт

```bash
python test_force_reindex.py f1896ee0-d548-4676-a0a5-02ac09e6aad9
```

## Логи процесса

Эндпоинт выводит подробные логи:

```
=== ПРИНУДИТЕЛЬНАЯ ПЕРЕИНДЕКСАЦИЯ СЕССИИ f1896ee0-d548-4676-a0a5-02ac09e6aad9 ===
Сессия валидирована: Тестовая фотосессия
Найдено 13 фото в облачной базе
Уже проиндексировано локально: 3 фото
Нужно обработать: 10 новых фото
Обработка фото 1 из 10: photo_001.jpg
✅ Фото photo_001.jpg успешно обработано (confidence: 0.892)
Обработка фото 2 из 10: photo_002.jpg
✅ Фото photo_002.jpg успешно обработано (confidence: 0.756)
...
=== ПЕРЕИНДЕКСАЦИЯ ЗАВЕРШЕНА ===
Всего фото в облаке: 13
Уже проиндексировано: 3
Обработано новых: 10
Успешно: 8
Ошибок: 2
Время обработки: 45230.12ms
```

## Ответ API

```json
{
  "success": true,
  "message": "Переиндексация завершена: 8/10 новых фото",
  "session_id": "f1896ee0-d548-4676-a0a5-02ac09e6aad9",
  "session_name": "Тестовая фотосессия",
  "total_photos": 13,
  "processed_photos": 10,
  "successful_photos": 8,
  "skipped_photos": 3,
  "failed_photos": 2,
  "processing_time_ms": 45230.12,
  "errors": [
    "Лицо не обнаружено в фото corrupted_image.jpg",
    "Ошибка скачивания missing_file.jpg: 404 Not Found"
  ],
  "final_embedding_count": 11
}
```

## Обработка ошибок

Эндпоинт обрабатывает различные типы ошибок:

- **Сессия не найдена** (404)
- **FacePass не активен** (403) 
- **Ошибки скачивания фото** (сетевые проблемы, 404)
- **Лицо не обнаружено** (InsightFace не может найти лицо)
- **Поврежденные изображения** (неверный формат)

## Безопасность

- Валидация существования сессии
- Проверка активности FacePass для сессии
- Таймауты для скачивания (30 секунд)
- Откат транзакций при ошибках
- Ограничение количества ошибок в ответе (первые 10)

## Производительность

- Обработка только новых фото (пропуск уже проиндексированных)
- Нормализация эмбеддингов для консистентности
- Подробная статистика времени выполнения
- Пакетная обработка с коммитами после каждого успешного фото