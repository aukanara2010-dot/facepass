# Исправление полей базы данных и нормализации векторов - Отчет

## Проблемы, которые были исправлены

### 1. Неправильные поля базы данных
- **Проблема**: Использовались несуществующие поля `url_preview` и `url_original`
- **Решение**: Заменены на правильные поля `preview_path` и `file_path`

### 2. Ненормализованные векторы
- **Проблема**: Значения сходства 448.0+ указывали на ненормализованные векторы
- **Решение**: Добавлена нормализация векторов при индексации и поиске

### 3. Неоптимальный оператор сходства
- **Проблема**: Использовался скалярное произведение для ненормализованных векторов
- **Решение**: Переход на косинусное сходство `<=>`, которое работает с любыми векторами

### 4. Неправильный порог сходства
- **Проблема**: Порог 0.3 был слишком низким
- **Решение**: Возвращен стандартный порог 0.6

## Детальные изменения

### Поля базы данных
**Файл**: `app/api/v1/endpoints/faces.py`

```sql
-- Было:
SELECT id, file_name, url_preview, url_original, created_at
FROM public.photos

-- Стало:
SELECT id, file_name, preview_path, file_path, created_at
FROM public.photos
```

**API ответ**:
```json
// Было:
{
  "url_preview": "...",
  "url_original": "..."
}

// Стало:
{
  "preview_path": "...",
  "file_path": "..."
}
```

### Нормализация векторов

**При поиске** (`app/api/v1/endpoints/faces.py`):
```python
# Добавлено после извлечения эмбеддинга:
import numpy as np
embedding_norm = np.linalg.norm(query_embedding)
if embedding_norm > 0:
    query_embedding = query_embedding / embedding_norm
    logger.info(f"Embedding normalized (original norm: {embedding_norm:.6f})")
```

**При индексации** (`services/photo_indexing.py`):
```python
# Добавлено перед сохранением в базу:
embedding_norm = np.linalg.norm(embedding_vector)
if embedding_norm > 0:
    normalized_embedding = embedding_vector / embedding_norm
    logger.debug(f"Embedding normalized (original norm: {embedding_norm:.6f})")
```

### Косинусное сходство

**SQL запросы изменены с**:
```sql
-- Было (скалярное произведение):
SELECT (embedding <#> query) * -1 as similarity
ORDER BY embedding <#> query DESC

-- Стало (косинусное сходство):
SELECT 1 - (embedding <=> query) as similarity  
ORDER BY embedding <=> query ASC
```

### Порог сходства
**Файл**: `.env`
```bash
# Было:
FACE_SIMILARITY_THRESHOLD=0.3

# Стало:
FACE_SIMILARITY_THRESHOLD=0.6
```

## Измененные файлы

### Основные файлы
- `app/api/v1/endpoints/faces.py` - Исправлены поля БД, добавлена нормализация, изменены SQL запросы
- `services/photo_indexing.py` - Добавлена нормализация при сохранении эмбеддингов
- `workers/tasks.py` - Добавлена нормализация и изменены SQL запросы
- `.env` - Изменен порог сходства на 0.6

### Тестовые и вспомогательные файлы
- `test_auto_indexing_flow.py` - Обновлены SQL запросы
- `scripts/init_facepass_tables.sql` - Обновлены примеры запросов
- `scripts/init_db.py` - Обновлен тестовый запрос

## Технические детали

### Операторы pgvector
| Оператор | Описание | Когда использовать |
|----------|----------|-------------------|
| `<#>` | Скалярное произведение | Нормализованные векторы |
| `<=>` | **Косинусное расстояние** | **Любые векторы (универсальный)** |
| `<->` | Евклидово расстояние | Координатные данные |

### Формула сходства
```sql
-- Косинусное сходство (0.0 - 1.0):
1 - (embedding <=> query_embedding)

-- Где:
-- <=> возвращает косинусное расстояние (0.0 - 2.0)
-- 1 - distance = similarity (1.0 = идентичные, 0.0 = противоположные)
```

### Нормализация векторов
```python
# Приведение к единичной длине:
normalized_vector = vector / np.linalg.norm(vector)

# Результат: ||normalized_vector|| = 1.0
```

## Ожидаемые результаты

### До исправления
- Значения сходства: 448.0, -10.3, -19.7 (неправильные)
- Поля API: `url_preview`, `url_original` (несуществующие)
- Порог: 0.3 (слишком низкий)

### После исправления
- Значения сходства: 0.0 - 1.0 (правильный диапазон)
- Поля API: `preview_path`, `file_path` (существующие)
- Порог: 0.6 (стандартный)

### Логи
```
SIMILARITY DEBUG - Session abc123: Max similarity = 0.8234, Threshold = 0.6
SIMILARITY DEBUG - Session abc123: 2 matches above 0.6, similarities: [0.8234, 0.7891]
Embedding normalized (original norm: 374.165741)
```

## Преимущества изменений

1. **Правильные данные**: API возвращает существующие поля базы данных
2. **Стабильные результаты**: Нормализация обеспечивает консистентность
3. **Универсальность**: Косинусное сходство работает с любыми векторами
4. **Точность**: Стандартный порог 0.6 для лучшего качества поиска
5. **Производительность**: Оптимизированные SQL запросы

## Проверка исправлений

Создан тест `test_database_fields_fix.py`, который проверяет:
- ✅ Порог установлен на 0.6
- ✅ Косинусное сходство работает корректно
- ✅ Нормализация приводит векторы к единичной длине
- ✅ Используются правильные поля базы данных

## Заключение

Все критические проблемы исправлены:
- **Поля базы данных**: Теперь используются правильные `preview_path` и `file_path`
- **Нормализация векторов**: Добавлена во все места работы с эмбеддингами
- **Косинусное сходство**: Универсальный и надежный метод сравнения
- **Стандартный порог**: 0.6 для качественного поиска лиц

**Система теперь будет работать корректно и стабильно!**